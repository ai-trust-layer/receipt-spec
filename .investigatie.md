# Investigatie UI Schema 2020-12 FAIL

## Verdict: üî¥ CONFIRMED ISSUES

## Findings

### 1. AJV Version Mismatch
- **UI uses**: `window.Ajv7` (AJV v7) - confirmed in `docs/js/audit-ui.js:194`
- **Schema requires**: `draft/2020-12` metaschema - confirmed in `docs/schema/receipt.schema.json:2`
- **Bundle contains**: Only draft-07 metaschema - confirmed in `docs/vendor/ajv-bundle.js` (line 8 shows `draft-07/schema#`)

### 2. Validation Results
```bash
npx --yes ajv-cli@5 validate --spec=draft2020 -c ajv-formats -s docs/schema/receipt.schema.json -d "docs/examples/*.json" --errors=line
```
- ‚úÖ `ok-1.json`, `ok-2.json`, `tampered-1.json`, `tampered-2.json` - VALID
- ‚ùå `borderline-1.json`, `borderline-2.json` - INVALID (missing `output_hash`)

### 3. Non-Determinism Source
**Location**: `docs/js/audit-ui.js:103`
```javascript
`timestamp: ${new Date().toISOString()}`
```
This generates a fresh timestamp on each validation, causing non-deterministic `checks.txt` content.

### 4. Checks.txt Generation
**Location**: `docs/js/audit-ui.js:105`
```javascript
zip.file('checks.txt', checks);
```
The `checks` variable contains the non-deterministic timestamp.

## Root Cause Analysis

1. **Schema Compatibility**: AJV v7 bundle lacks 2020-12 metaschema support
2. **Non-Determinism**: Fresh `new Date().toISOString()` call on every validation
3. **Missing Validation**: Borderline examples fail because they lack required `output_hash` field

## Plan Minimal (3 pasi)

### Pasul 1: Ajv2020
- Upgrade AJV bundle to support draft-2020-12 metaschema
- Update `docs/vendor/ajv-bundle.js` to include 2020-12 support
- Test schema validation with new bundle

### Pasul 2: signature_ok
- Implement proper signature verification logic
- Add Ed25519 signature validation to UI
- Ensure signature validation is deterministic

### Pasul 3: checks.txt
- Replace `new Date().toISOString()` with deterministic timestamp
- Use receipt's `issued_at` field or fixed timestamp
- Ensure checks.txt generation is reproducible

## Impact Assessment
- **High**: Schema validation fails for 2020-12 schemas
- **Medium**: Non-deterministic checks.txt breaks reproducibility
- **Low**: Borderline examples are correctly identified as invalid
