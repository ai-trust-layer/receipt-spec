<!doctype html><meta charset="utf-8"><title>Verify Receipt (schema-only)</title>
<h3>Verify Receipt (schema-only)</h3>
<input type="file" id="receipt" accept=".json">
<pre id="out"></pre>
<script type="module">
import Ajv from "https://cdn.jsdelivr.net/npm/ajv@8/dist/ajv2020.min.js";
import addFormats from "https://cdn.jsdelivr.net/npm/ajv-formats@2/dist/ajv-formats.min.js";
const out = x => document.getElementById('out').textContent = x;

const schema = await (await fetch('../schema/receipt.schema.json',{cache:'no-store'})).json();
const ajv = new Ajv({allErrors:true, strict:false});
addFormats(ajv);
const validate = ajv.compile(schema);

document.getElementById('receipt').addEventListener('change', async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;
  const text = await file.text();
  let data;
  try { data = JSON.parse(text); } catch(e){ out('Invalid JSON'); return; }
  const ok = validate(data);
  const res = {
    pass: ok,
    schema_ok: ok,
    schema_errors: ok ? [] : (validate.errors || [])
  };
  out(JSON.stringify(res,null,2));
});
</script>
  <hr>
  <section id="audit-pack">
    <h3>Audit pack</h3>
    <p>Încarcă un receipt JSON și descarcă un pachet ZIP cu schema și raportul de verificare.</p>
    <input type="file" id="auditFile" accept="application/json">
    <button id="btnAudit" disabled>Download audit pack</button>
  </section>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script>
  (function(){
    const fileEl = document.getElementById('auditFile');
    const btn = document.getElementById('btnAudit');
    let receiptObj = null;

    fileEl?.addEventListener('change', async (e) => {
      const f = e.target.files?.[0];
      if(!f){ btn.disabled = true; return; }
      try{
        const txt = await f.text();
        receiptObj = JSON.parse(txt);
        btn.disabled = false;
      }catch{
        alert('Invalid JSON'); btn.disabled = true;
      }
    });

    btn?.addEventListener('click', async () => {
      if(!receiptObj){ return; }
      const zip = new JSZip();
      zip.file('receipt.json', JSON.stringify(receiptObj, null, 2));
      const schemaTxt = await fetch('receipt.schema.json', {cache:'no-store'}).then(r=>r.text());
      zip.file('receipt.schema.json', schemaTxt);
      const report = {
        id: receiptObj.id || null,
        issued_at: receiptObj.issued_at || null,
        policy_version: receiptObj.policy_version || null,
        policy_hash: receiptObj.policy_hash || null,
        input_hash: receiptObj.input_hash || null,
        output_hash: receiptObj.output_hash || null,
        anchors: receiptObj.proof_refs || []
      };
      zip.file('verify_report.json', JSON.stringify(report, null, 2));
      const fnSafe = (receiptObj.id || 'receipt').replace(/[^a-zA-Z0-9._-]/g,'_');
      const blob = await zip.generateAsync({type:'blob'});
      saveAs(blob, `audit_${fnSafe}.zip`);
    });
  })();
  </script>
<section style="margin-top:32px">
  <a href="https://github.com/ai-trust-layer/receipt-spec/issues/new?template=pilot_request.md" target="_blank" rel="noopener" style="display:inline-block;padding:10px 14px;border:1px solid #111;text-decoration:none">Apply for pilot</a>
</section>
